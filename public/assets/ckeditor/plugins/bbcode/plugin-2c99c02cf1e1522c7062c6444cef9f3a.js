/*
Copyright (c) 2003-2011, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function i(a){var b="";for(var c in a){var d=a[c],e=(c+":"+d).replace(h,";");b+=e}return b}function j(a){var b={};return(a||"").replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,c,d){b[c.toLowerCase()]=d}),b}function k(a){return a.replace(/(?:rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\))/gi,function(a,b,c,d){b=parseInt(b,10).toString(16),c=parseInt(c,10).toString(16),d=parseInt(d,10).toString(16);var e=[b,c,d];for(var f=0;f<e.length;f++)e[f]=String("0"+e[f]).slice(-2);return"#"+e.join("")})}CKEDITOR.on("dialogDefinition",function(a){var b,c=a.data.name,d=a.data.definition;c=="link"?(d.removeContents("target"),d.removeContents("upload"),d.removeContents("advanced"),b=d.getContents("info"),b.remove("emailSubject"),b.remove("emailBody")):c=="image"&&(d.removeContents("advanced"),b=d.getContents("Link"),b.remove("cmbTarget"),b=d.getContents("info"),b.remove("txtAlt"),b.remove("basic"))});var a={b:"strong",u:"u",i:"em",color:"span",size:"span",quote:"blockquote",code:"code",url:"a",email:"span",img:"span","*":"li",list:"ol"},b={strong:"b",b:"b",u:"u",em:"i",i:"i",code:"code",li:"*"},c={strong:"b",em:"i",u:"u",li:"*",ul:"list",ol:"list",code:"code",a:"link",img:"img",blockquote:"quote"},d={color:"color",size:"font-size"},e={url:"href",email:"mailhref",quote:"cite",list:"listType"},f=CKEDITOR.dtd,g=CKEDITOR.tools.extend({table:1},f.$block,f.$listItem,f.$tableContent,f.$list),h=/\s*(?:;\s*|$)/,l={smiley:":)",sad:":(",wink:";)",laugh:":D",cheeky:":P",blush:":*)",surprise:":-o",indecision:":|",angry:">:(",angel:"o:)",cool:"8-)",devil:">:-)",crying:";(",kiss:":-*"},m={},n=[];for(var o in l)m[l[o]]=o,n.push(l[o].replace(/\(|\)|\:|\/|\*|\-|\|/g,function(a){return"\\"+a}));n=new RegExp(n.join("|"),"g");var p=function(){var a=[],b={nbsp:" ",shy:"­",gt:">",lt:"<"};for(var c in b)a.push(c);return a=new RegExp("&("+a.join("|")+");","g"),function(c){return c.replace(a,function(a,c){return b[c]})}}();CKEDITOR.BBCodeParser=function(){this._={bbcPartsRegex:/(?:\[([^\/\]=]*?)(?:=([^\]]*?))?\])|(?:\[\/([a-z]{1,16})\])/ig}},CKEDITOR.BBCodeParser.prototype={parse:function(b){var c=this,f,g,h=0;while(f=c._.bbcPartsRegex.exec(b)){var j=f.index;if(j>h){var k=b.substring(h,j);c.onText(k,1)}h=c._.bbcPartsRegex.lastIndex,g=(f[1]||f[3]||"").toLowerCase();if(g&&!a[g]){c.onText(f[0]);continue}if(f[1]){var l=a[g],m={},n={},o=f[2];o&&(g=="list"&&(isNaN(o)?/^[a-z]+$/.test(o)?o="lower-alpha":/^[A-Z]+$/.test(o)&&(o="upper-alpha"):o="decimal"),d[g]?(g=="size"&&(o+="%"),n[d[g]]=o,m.style=i(n)):e[g]&&(m[e[g]]=o));if(g=="email"||g=="img")m.bbcode=g;c.onTagOpen(l,m,CKEDITOR.dtd.$empty[l])}else f[3]&&c.onTagClose(a[g])}b.length>h&&c.onText(b.substring(h,b.length),1)}},CKEDITOR.htmlParser.fragment.fromBBCode=function(a){function j(a){if(e.length>0)for(var b=0;b<e.length;b++){var c=e[b],d=c.name,f=CKEDITOR.dtd[d],g=h.name&&CKEDITOR.dtd[h.name];(!g||g[d])&&(!a||!f||f[a]||!CKEDITOR.dtd[a])&&(c=c.clone(),c.parent=h,h=c,e.splice(b,1),b--)}}function k(a,b){var d=h.children.length,e=d>0&&h.children[d-1],i=!e&&q.getRule(c[h.name],"breakAfterOpen"),j=e&&e.type==CKEDITOR.NODE_ELEMENT&&q.getRule(c[e.name],"breakAfterClose"),k=a&&q.getRule(c[a],b?"breakBeforeClose":"breakBeforeOpen");f&&(i||j||k)&&f--,f&&a in g&&f++;while(f&&f--)h.children.push(e=new CKEDITOR.htmlParser.element("br"))}function l(a,b){k(a.name,1),b=b||h||d;var c=b.children.length,e=c>0&&b.children[c-1]||null;a.previous=e,a.parent=b,b.children.push(a),a.returnPoint&&(h=a.returnPoint,delete a.returnPoint)}var b=new CKEDITOR.BBCodeParser,d=new CKEDITOR.htmlParser.fragment,e=[],f=0,h=d,i;b.onTagOpen=function(a,c,d){var f=new CKEDITOR.htmlParser.element(a,c);if(CKEDITOR.dtd.$removeEmpty[a]){e.push(f);return}var g=h.name,m=g&&(CKEDITOR.dtd[g]||(h._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span));if(m&&!m[a]){var n=!1,o;a==g?l(h,h.parent):a in CKEDITOR.dtd.$listItem?(b.onTagOpen("ul",{}),o=h,n=!0):(l(h,h.parent),e.unshift(h),n=!0),o?h=o:h=h.returnPoint||h.parent;if(n){b.onTagOpen.apply(this,arguments);return}}j(a),k(a),f.parent=h,f.returnPoint=i,i=0,f.isEmpty?l(f):h=f},b.onTagClose=function(a){for(var b=e.length-1;b>=0;b--)if(a==e[b].name){e.splice(b,1);return}var c=[],d=[],f=h;while(f.type&&f.name!=a)f._.isBlockLike||d.unshift(f),c.push(f),f=f.parent;if(f.type){for(b=0;b<c.length;b++){var g=c[b];l(g,g.parent)}h=f,l(f,f.parent),f==h&&(h=h.parent),e=e.concat(d)}},b.onText=function(a){var b=CKEDITOR.dtd[h.name];if(!b||b["#"])k(),j(),a.replace(/([\r\n])|[^\r\n]*/g,function(a,b){if(b!==undefined&&b.length)f++;else if(a.length){var c=0;a.replace(n,function(b,d){l(new CKEDITOR.htmlParser.text(a.substring(c,d)),h),l(new CKEDITOR.htmlParser.element("smiley",{desc:m[b]}),h),c=d+b.length}),c!=a.length&&l(new CKEDITOR.htmlParser.text(a.substring(c,a.length)),h)}})},b.parse(CKEDITOR.tools.htmlEncode(a));while(h.type){var o=h.parent,p=h;l(p,o),h=o}return d},CKEDITOR.htmlParser.BBCodeWriter=CKEDITOR.tools.createClass({$:function(){var a=this;a._={output:[],rules:[]},a.setRules("list",{breakBeforeOpen:1,breakAfterOpen:1,breakBeforeClose:1,breakAfterClose:1}),a.setRules("*",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:1,breakAfterClose:0}),a.setRules("quote",{breakBeforeOpen:1,breakAfterOpen:0,breakBeforeClose:0,breakAfterClose:1})},proto:{setRules:function(a,b){var c=this._.rules[a];c?CKEDITOR.tools.extend(c,b,!0):this._.rules[a]=b},getRule:function(a,b){return this._.rules[a]&&this._.rules[a][b]},openTag:function(b,c){var d=this;if(b in a){d.getRule(b,"breakBeforeOpen")&&d.lineBreak(1),d.write("[",b);var e=c.option;e&&d.write("=",e),d.write("]"),d.getRule(b,"breakAfterOpen")&&d.lineBreak(1)}else b=="br"&&d._.output.push("\n")},openTagClose:function(){},attribute:function(){},closeTag:function(b){var c=this;b in a&&(c.getRule(b,"breakBeforeClose")&&c.lineBreak(1),b!="*"&&c.write("[/",b,"]"),c.getRule(b,"breakAfterClose")&&c.lineBreak(1))},text:function(a){this.write(a)},comment:function(){},lineBreak:function(){var a=this;!a._.hasLineBreak&&a._.output.length&&(a.write("\n"),a._.hasLineBreak=1)},write:function(){this._.hasLineBreak=0;var a=Array.prototype.join.call(arguments,"");this._.output.push(a)},reset:function(){this._.output=[],this._.hasLineBreak=0},getHtml:function(a){var b=this._.output.join("");return a&&this.reset(),p(b)}}});var q=new CKEDITOR.htmlParser.BBCodeWriter;CKEDITOR.plugins.add("bbcode",{requires:["htmldataprocessor","entities"],beforeInit:function(a){var b=a.config;CKEDITOR.tools.extend(b,{enterMode:CKEDITOR.ENTER_BR,basicEntities:!1,entities:!1,fillEmptyBlocks:!1},!0)},init:function(a){function d(a){var b=CKEDITOR.htmlParser.fragment.fromBBCode(a),c=new CKEDITOR.htmlParser.basicWriter;return b.writeHtml(c,e),c.getHtml(!0)}var c=a.config,e=new CKEDITOR.htmlParser.filter;e.addRules({elements:{blockquote:function(a){var b=new CKEDITOR.htmlParser.element("div");b.children=a.children,a.children=[b];var c=a.attributes.cite;if(c){var d=new CKEDITOR.htmlParser.element("cite");d.add(new CKEDITOR.htmlParser.text(c.replace(/^"|"$/g,""))),delete a.attributes.cite,a.children.unshift(d)}},span:function(a){var b;if(b=a.attributes.bbcode)b=="img"?(a.name="img",a.attributes.src=a.children[0].value,a.children=[]):b=="email"&&(a.name="a",a.attributes.href="mailto:"+a.children[0].value),delete a.attributes.bbcode},ol:function(a){a.attributes.listType?a.attributes.listType!="decimal"&&(a.attributes.style="list-style-type:"+a.attributes.listType):a.name="ul",delete a.attributes.listType},a:function(a){a.attributes.href||(a.attributes.href=a.children[0].value)},smiley:function(a){a.name="img";var b=a.attributes.desc,d=c.smiley_images[CKEDITOR.tools.indexOf(c.smiley_descriptions,b)],e=CKEDITOR.tools.htmlEncode(c.smiley_path+d);a.attributes={src:e,"data-cke-saved-src":e,title:b,alt:b}}}}),a.dataProcessor.htmlFilter.addRules({elements:{$:function(c){var d=c.attributes,e=j(d.style),f,g=c.name;if(g in b)g=b[g];else if(g=="span"){if(f=e.color)g="color",f=k(f);else if(f=e["font-size"]){var h=f.match(/(\d+)%$/);h&&(f=h[1],g="size")}}else if(g=="ol"||g=="ul"){if(f=e["list-style-type"])switch(f){case"lower-alpha":f="a";break;case"upper-alpha":f="A"}else g=="ol"&&(f=1);g="list"}else if(g=="blockquote"){try{var i=c.children[0],m=c.children[1],n=i.name=="cite"&&i.children[0].value;n&&(f='"'+n+'"',c.children=m.children)}catch(o){}g="quote"}else if(g=="a"){if(f=d.href)if(f.indexOf("mailto:")!==-1)g="email",c.children=[new CKEDITOR.htmlParser.text(f.replace("mailto:",""))],f="";else{var p=c.children.length==1&&c.children[0];p&&p.type==CKEDITOR.NODE_TEXT&&p.value==f&&(f=""),g="url"}}else if(g=="img"){c.isEmpty=0;var q=d["data-cke-saved-src"];if(q&&q.indexOf(a.config.smiley_path)!=-1)return new CKEDITOR.htmlParser.text(l[d.alt]);c.children=[new CKEDITOR.htmlParser.text(q)]}return c.name=g,f&&(c.attributes.option=f),null},br:function(a){var b=a.next;if(b&&b.name in g)return!1}}},1),a.dataProcessor.writer=q,a.on("beforeSetMode",function(b){b.removeListener();var c=a._.modes.wysiwyg;c.loadData=CKEDITOR.tools.override(c.loadData,function(a){return function(b){return a.call(this,d(b))}})})},afterInit:function(a){var b;a._.elementsPath&&(b=a._.elementsPath.filters)&&b.push(function(b){var d=b.getName(),e=c[d]||!1;if(e=="link"&&b.getAttribute("href").indexOf("mailto:")===0)e="email";else if(d=="span")b.getStyle("font-size")?e="size":b.getStyle("color")&&(e="color");else if(e=="img"){var f=b.data("cke-saved-src");f&&f.indexOf(a.config.smiley_path)===0&&(e="smiley")}return e})}})})();